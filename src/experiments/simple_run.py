import json
import sys
from datetime import datetime
from pathlib import Path




src_path = Path(__file__).resolve().parent.parent  # this will be the 'src' directory
if str(src_path) not in sys.path:
    sys.path.insert(0, str(src_path))

# Corrected: Use an absolute import now that the path is set
from experiments.simple_graph import simple_graph, SimpleAgentState


def run_simple_workflow(query: str, run_timestamp: str):
    """Runs the simple, zero-shot agentic workflow."""
    print("\n--- Running Simple Agentic Workflow ---")

    # 1. Define the initial state
    initial_state: SimpleAgentState = {
        "initial_query": query,
        "generated_ideas": None,
        "refined_ideas": None,
    }
    print(f"Starting simple workflow for query: '{initial_state['initial_query']}'")

    # 2. Run the graph
    final_state = simple_graph.invoke(initial_state)

    # 3. View the final list of novel ideas
    print("\n\n--- FINAL REFINED IDEAS ---")
    if final_state.get("refined_ideas"):
        for i, idea in enumerate(final_state["refined_ideas"].final_ideas):
            print(f"{i+1}. {idea.title}")
            print(f"   Description: {idea.description}\n")
    else:
        print("No final ideas were generated by the simple workflow.")

    # 4. Save the final state to a JSON file (optional, but good practice)
    try:
        from pathlib import Path

        
        results_dir = Path(__file__).resolve().parent.parent.parent / "results" / "simple_agent_states"
        results_dir.mkdir(parents=True, exist_ok=True)
        
        state_path = results_dir / f"simple_workflow_state_{run_timestamp}.json"
        
        # A simple serializer for this state
        def simple_serializer(obj):
            if hasattr(obj, 'dict'):
                return obj.dict()
            return str(obj)

        with open(state_path, 'w', encoding='utf-8') as f:
            json.dump(final_state, f, indent=4, default=simple_serializer)
            
        print(f"Final state saved successfully to: {state_path}")

    except Exception as e:
        print(f"\nError saving final state: {e}")
    
    print("\n--- Simple agentic workflow finished. ---")
    return final_state


if __name__ == "__main__":
    # Path to the state file from which to load the query
    project_root = Path(__file__).resolve().parent.parent.parent
    state_file_path = project_root / "results" / "agent_states" / "workflow_state_20250904_092251.json"
    
    try:
        with open(state_file_path, 'r', encoding='utf-8') as f:
            state_data = json.load(f)
        
        user_query = state_data.get("initial_query")

        if user_query:
            # Run the workflow with the loaded query
            run_simple_workflow(user_query.strip())
        else:
            print(f"Error: 'initial_query' not found in {state_file_path}")

    except FileNotFoundError:
        print(f"Error: State file not found at {state_file_path}")
    except json.JSONDecodeError:
        print(f"Error: Could not decode JSON from {state_file_path}")
    except Exception as e:
        print(f"An unexpected error occurred: {e}")